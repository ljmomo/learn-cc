# 知识星球文件下载器 - 链接解析功能

## 功能概述

本功能支持从知识星球给定的链接中解析并下载文件，完整操作流程如下：

## 完整操作流程

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 初始页面：给定链接                                          │
│    https://wx.zsxq.com/group/xxx/topic/xxx                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. 提取书籍列表（智能过滤评论）                                 │
│    - 识别书籍链接（如"投资中最简单的事"）                        │
│    - 提取链接地址（如 https://t.zsxq.com/xxx）                │
│    - 过滤评论内容                                              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. 导航到书籍详情页                                            │
│    - 直接使用URL导航（而不是点击）                              │
│    - 等待页面加载完成                                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. 提取详情页附件（智能过滤评论）                               │
│    - 识别附件文件（.mp3, .docx, .pdf等）                       │
│    - 支持 link 和 detail_file 类型                            │
│    - 过滤评论内容                                              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. 点击附件，打开下载弹窗                                       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 6. 智能评分系统找到下载按钮                                     │
│    评分规则：                                                  │
│    - 文本恰好是"下载"：得分 100                                 │
│    - 文本包含"下载"且长度<20：得分 80                           │
│    - 文本包含"下载"：得分 50                                    │
│    - cursor是pointer：+10分                                    │
│    - 是button或a标签：+10分                                    │
│    - 得分>=80才认为是有效下载按钮                               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 7. 点击下载按钮                                                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 8. 等待下载完成并保存文件                                       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 9. 关闭弹窗，返回初始页面，处理下一本书籍                        │
└─────────────────────────────────────────────────────────────┘
```

## 关键功能特性

### 1. 智能评论过滤

系统会自动过滤评论内容，只提取书籍和附件信息：

**过滤规则：**
- 包含评论关键词：'评论', '回复', '留言', 'comment', 'reply', '评论区', '回复区', '留言区', '评论者', '回复者'
- 包含时间戳格式：如 2021-05-08
- 用户名格式：如 "用户名："
- 多行内容：超过3行
- 长文本：超过200字符

### 2. 智能下载按钮识别

使用评分系统精确识别真正的下载按钮，避免误点击：

**评分规则：**
| 条件 | 得分 |
|------|------|
| 文本恰好是"下载" | 100分 |
| 文本包含"下载"且长度<20 | 80分 |
| 文本包含"下载" | 50分 |
| cursor是pointer | +10分 |
| 是button或a标签 | +10分 |

**有效下载按钮：** 得分 >= 80

### 3. 可靠的导航方式

- 使用URL直接导航，而不是点击元素
- 避免点击失效或跳转失败的问题
- 提高操作可靠性

### 4. 多类型附件支持

支持以下类型的附件：
- `link`：链接类型（如 .mp3 文件链接）
- `detail_file`：详情页文件类型
- `book_link`：书籍链接类型

## 使用方法

### 方式1：使用测试脚本

```bash
python3 test_detailed_flow.py
```

### 方式2：使用主程序

```bash
python3 zsxq_playwright.py --links links.txt
```

### 方式3：在代码中调用

```python
from zsxq_playwright import ZSXQDownloader

downloader = ZSXQDownloader(
    download_dir="./downloads",
    user_data_dir="./browser_data"
)

links = ["https://wx.zsxq.com/group/xxx/topic/xxx"]
downloader.download_from_links(links)
```

## 配置文件

在 `links.txt` 中配置要处理的链接：

```
# 知识星球链接配置文件
# 每行一个链接，支持注释

https://wx.zsxq.com/group/454548818428/topic/215121512511251
# https://wx.zsxq.com/group/xxx/topic/xxx  # 可以注释掉不需要的链接
```

## 输出示例

```
============================================================
🔗 步骤1: 打开初始页面
============================================================
   URL: https://wx.zsxq.com/group/454548818428/topic/215121512511251

============================================================
📚 步骤2: 提取书籍列表
============================================================
   📂 类型: book_link (44 个)
   [1] 投资中最简单的事
       链接: https://t.zsxq.com/iAmIYZn...

============================================================
📖 步骤3: 导航到第一本书籍详情页
============================================================
   书籍名称: 投资中最简单的事
   🔗 导航到: https://t.zsxq.com/iAmIYZn
   ✅ 成功导航到详情页

============================================================
📎 步骤4: 提取详情页面附件
============================================================
   📂 类型: link (2 个)
   [1] 投资中最简单的事 合集.mp3

============================================================
📄 步骤5: 点击第一个附件
============================================================
   附件名称: 投资中最简单的事 合集.mp3
   点击坐标: (640, 414)

============================================================
🔍 步骤6: 查找下载按钮
============================================================
   ✅ 找到最佳下载按钮: '下载' (得分: 110)
   📍 点击坐标: (640, 414)
   ✅ 已点击下载按钮
   💾 文件应该开始下载...

🎉 测试完成！
```

## 注意事项

1. **首次使用**：需要在浏览器中登录知识星球
2. **登录状态**：系统会保存登录状态，下次无需重新登录
3. **下载目录**：文件会保存到指定的下载目录
4. **等待时间**：系统会自动等待页面加载和下载完成
5. **错误处理**：如果某个步骤失败，系统会继续处理下一个

## 技术实现

- **浏览器自动化**：Playwright
- **智能元素定位**：JavaScript + CSS选择器
- **评论过滤**：关键词匹配 + 内容分析
- **下载按钮识别**：智能评分系统
- **状态管理**：浏览器持久化上下文
